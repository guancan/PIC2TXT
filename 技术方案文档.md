# pics_2_txt 技术方案

## 项目概述
**pics_2_txt** 是一个简单的批量图片/PDF处理工具，主要功能是下载图片并进行OCR识别。支持本地OCR引擎和在线OCR服务。

## 技术选型

### 前端方案
- **Streamlit**：使用Python直接构建简单界面，无需学习前端技术

### 后端方案
- **纯Python实现**：不使用复杂的FastAPI+Celery架构
- **SQLite**：轻量级数据库，无需安装额外服务
- **OCR引擎**：
  - 本地引擎：PaddleOCR
  - 在线服务：Mistral AI OCR和NLP

## 系统架构
```
+----------------+      +----------------+
|                |      |                |
|  Streamlit UI  +----->+  Python后端    |
|  (前端界面)     |      |  (处理逻辑)    |
|                |      |                |
+----------------+      +-------+--------+
                                |
                                v
                +---------------+---------------+
                |                               |
+---------------v-----------+   +---------------v-----------+   +---------------v-----------+
|                           |   |                           |   |                           |
|   本地PaddleOCR引擎        |   |   Mistral AI OCR服务      |   |   Mistral AI NLP服务      |
|                           |   |                           |   |                           |
+---------------------------+   +---------------------------+   +---------------------------+
```

系统采用模块化设计，主要包含以下组件：
- **Streamlit前端**：提供用户交互界面，支持任务提交、管理和结果查看
- **Python后端**：处理核心业务逻辑，包括文件下载、OCR处理和任务管理
- **OCR服务**：支持三种OCR引擎
  - **本地PaddleOCR**：适用于离线环境，支持中英文混合识别
  - **Mistral AI OCR**：在线OCR服务，支持高精度文本识别
  - **Mistral AI NLP**：在线自然语言分析服务，提供结构化内容描述
- **服务工厂**：通过工厂模式创建不同类型的OCR服务，提供统一接口

## 功能模块
1. **下载模块**：支持图片/PDF链接下载
2. **OCR处理模块**：支持多种OCR引擎，统一接口，批量处理
3. **任务管理**：任务状态跟踪，OCR引擎选择
4. **结果展示**：OCR结果显示，TXT导出，结果合并

## 项目结构
```
pics_2_txt/
│
├── app.py                  # 主程序入口，Streamlit应用
├── config.py               # 配置文件，存储路径、OCR设置等
│
├── database/               # 数据库模块
│   ├── db_manager.py       # 数据库管理类
│   └── models.py           # 数据模型定义
│
├── services/               # 服务模块
│   ├── download_service.py # 图片/PDF下载服务
│   ├── ocr/                # OCR服务模块
│   │   ├── base_ocr.py     # OCR服务基类
│   │   ├── paddle_ocr.py   # PaddleOCR实现
│   │   ├── mistral_ocr.py  # Mistral AI OCR实现
│   │   └── mistral_nlp.py  # Mistral AI NLP实现
│   ├── ocr_factory.py      # OCR服务工厂
│   └── task_service.py     # 任务处理服务
│
├── utils/                  # 工具模块
│   ├── file_utils.py       # 文件处理工具
│   └── ocr_utils.py        # OCR相关工具函数
│
├── ui/                     # UI模块
│   ├── home_page.py        # 首页UI组件
│   ├── task_page.py        # 任务管理页面UI组件
│   └── result_page.py      # 结果展示页面UI组件
│
├── data/                   # 数据存储
│   ├── downloads/          # 下载的原始文件
│   └── results/            # OCR处理结果
│
└── database.db             # SQLite数据库文件
```

## 数据库表设计

### 任务表 (tasks)
```
- id: INTEGER PRIMARY KEY AUTOINCREMENT
- url: TEXT                 # 图片/PDF的URL
- file_path: TEXT           # 本地文件路径
- status: TEXT              # 状态：pending, processing, completed, failed
- ocr_engine: TEXT          # OCR引擎类型：local, mistral, nlp
- created_at: TIMESTAMP     # 创建时间
- updated_at: TIMESTAMP     # 更新时间
- error_message: TEXT       # 错误信息（如果有）
```

### 结果表 (results)
```
- id: INTEGER PRIMARY KEY AUTOINCREMENT
- task_id: INTEGER          # 关联的任务ID
- text_content: TEXT        # OCR识别的文本内容
- result_path: TEXT         # 结果文件路径
- created_at: TIMESTAMP     # 创建时间
- FOREIGN KEY (task_id) REFERENCES tasks (id)  # 外键约束
```

## 模块详细设计

### 1. 配置模块 (config.py)
集中管理所有配置信息，包括：
- 文件路径配置：BASE_DIR、TEMP_DIR、RESULT_DIR、DOWNLOAD_DIR等基础路径
- 数据库配置：DB_PATH指定SQLite数据库文件位置
- OCR引擎配置：DEFAULT_OCR_ENGINE设置默认OCR引擎
- API密钥配置：通过环境变量管理MISTRAL_API_KEY等敏感信息
- 日志配置：LOG_LEVEL和LOG_FORMAT控制日志输出格式和级别

### 2. 数据库模块 (database/)

**models.py**：定义数据库表结构和常量
- 任务状态常量：PENDING、PROCESSING、COMPLETED、FAILED等状态定义
- OCR引擎类型常量：LOCAL、MISTRAL、NLP等引擎类型定义
- 表结构定义：使用SQL语句定义tasks和results表结构

**db_manager.py**：提供数据库操作接口
- 数据库连接管理：支持上下文管理器模式
- 任务和结果的CRUD操作：完整的增删改查功能
- 数据库性能优化：WAL模式、缓存设置、同步模式配置
- 数据库维护功能：备份、修复、优化、状态检查等高级功能

### 3. OCR服务模块 (services/ocr/)

**base_ocr.py**：定义OCR服务基类接口
- 初始化方法：设置结果保存目录并验证写入权限
- 抽象方法：`check_installation`检查OCR服务是否可用
- 抽象方法：`process_image`处理单张图片并返回OCR结果
- 通用方法：`process_batch`批量处理多张图片

**paddle_ocr.py**：实现本地PaddleOCR服务
- 继承基类接口并实现所有抽象方法
- 动态检查PaddleOCR是否已安装
- 支持中英文混合识别和方向自动校正

**mistral_ocr.py**：实现Mistral AI OCR服务
- 继承基类接口并实现所有抽象方法
- 支持图片和PDF文件的OCR处理
- 实现API请求重试机制和频率限制控制

**mistral_nlp.py**：实现Mistral AI自然语言分析服务
- 继承基类接口并实现所有抽象方法
- 使用AI模型分析图片内容并生成结构化描述
- 支持Markdown格式输出，保留文档结构

### 4. 服务工厂 (services/ocr_factory.py)
- 提供`create_ocr_service`静态方法创建不同类型的OCR服务实例
- 支持三种OCR引擎：本地PaddleOCR、Mistral AI OCR和Mistral AI NLP
- 根据配置自动选择默认OCR引擎

### 5. OCR工具模块 (utils/ocr_utils.py)
- 提供`save_ocr_result`函数保存OCR结果到文件
- 提供`merge_ocr_results`函数合并多个OCR结果
- 提供`format_ocr_text`函数格式化OCR文本结果

### 6. 任务服务 (services/task_service.py)
- 管理任务生命周期：创建、处理、更新和删除任务
- 协调下载服务和OCR服务：根据任务类型调用相应服务
- 任务状态管理：跟踪和更新任务状态
- 错误处理和重试机制：支持API请求失败时的自动重试
- 频率控制：实现任务处理频率限制，避免API限制和资源竞争

### 7. 下载服务 (services/download_service.py)
- 处理URL下载：支持HTTP和HTTPS协议的图片和PDF文件下载
- 文件类型识别：从Content-Type头部、URL路径和参数分析
- 文件名处理：生成唯一文件名避免冲突
- 错误处理：捕获并记录网络错误、无效URL和文件不存在等异常
- 批量下载：支持多个URL的批量下载
- URL验证和文件类型验证：确保输入有效性

### 8. UI模块 (ui/)

**首页 (home_page.py)**
- 提供URL输入和本地文件上传
- 支持选择OCR引擎和处理模式
- 显示处理进度和结果
- 提供结果下载功能

**任务管理页面 (task_page.py)**
- 显示所有任务及其状态
- 支持任务查看、重新处理和删除
- 提供批量操作功能
- 数据库维护功能

**结果展示页面 (result_page.py)**
- 显示已完成任务的OCR结果
- 提供结果文本查看和下载
- 显示原始图片（如果可用）

## 系统集成

### 模块交互
- **UI与后端交互**：Streamlit前端通过直接调用Python函数与后端交互
- **任务流程**：用户输入 → 创建任务 → 下载文件 → OCR处理 → 保存结果 → 更新状态 → UI展示

### 异常处理
- **前端异常**：使用Streamlit的错误提示机制展示友好错误信息
- **下载异常**：捕获网络错误、无效URL和文件不存在等异常
- **OCR处理异常**：捕获OCR引擎错误和API限制等异常
- **数据库异常**：提供数据库修复和备份功能

## 部署和维护

### 部署方式
- **本地部署**：支持在本地环境直接运行
- **环境要求**：Python 3.8+，SQLite 3.x，PaddleOCR（可选）

### 系统维护
- **数据库维护**：提供整理、优化、清理缓存、备份和重置等功能
- **任务管理**：支持查看、重新处理和删除任务
- **批量操作**：支持批量删除任务和重试失败任务


